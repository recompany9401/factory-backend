generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserType {
  PERSONAL
  BUSINESS
}

enum UserRole {
  USER
  ADMIN
}

enum ResourceType {
  SECTION
  EQUIPMENT
  CONSULTING
}

enum BookingUnit {
  TIME
  DAY
}

enum ReservationStatus {
  PENDING
  CONFIRMED
  CANCELLED
  COMPLETED
  NOSHOW
}

enum ReservationItemStatus {
  PENDING
  CONFIRMED
  CANCELLED
}

enum PaymentStatus {
  PENDING
  PAID
  CANCELLED
  FAILED
  REFUNDED
  PARTIALLY_REFUNDED
}

enum PostType {
  GOV_SUPPORT  
  POLICY       
  NOTICE       
  PRESS
}

enum PostStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

enum InquiryType {
  GENERAL
  RESERVATION
  POLICY
}

enum InquiryStatus {
  NEW
  IN_PROGRESS
  DONE
}

enum PricingRuleType {
  DEFAULT
  TIME_RANGE
  DAY_OF_WEEK
  USER_TYPE
}

enum ScheduleType {
  WEEKLY
  EXCEPTION
}

enum NotificationChannel {
  KAKAO
  EMAIL
}

enum NotificationStatus {
  READY
  SENT
  FAILED
}

enum ResourceStatus {
  ACTIVE
  DELETED
}

enum BlockoutType {
  BLOCK 
  ALLOW  
}

model User {
  id             String    @id @default(uuid())
  
  email          String?   @unique 
  loginId        String?   @unique 
  
  passwordHash   String
  name           String
  phone          String?
  
  userType       UserType  @default(PERSONAL)
  userRole       UserRole  @default(USER)

  companyName    String?
  businessNumber String?

  representativeName String? 
  companyAddress     String? 
  businessType       String?
  businessItem       String?

  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  isBlacklisted Boolean   @default(false)
  adminMemo     String?   @db.Text

  reservations   Reservation[]
  inquiries      Inquiry[]
  notifications  Notification[]
}

model Notification {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  type      String  
  title     String   
  message   String  
  isRead    Boolean  @default(false) 
  
  createdAt DateTime @default(now())
}

model VerificationCode {
  id        Int      @id @default(autoincrement())
  email     String   @unique
  code      String
  expiresAt DateTime
  createdAt DateTime @default(now())
}

model Resource {
  id          String       @id @default(uuid())
  type        ResourceType
  name        String
  description String?
  bookingUnit BookingUnit  @default(TIME)

  mainSectionId String?
  mainSection   Resource?  @relation("SectionToChildren", fields: [mainSectionId], references: [id])
  children      Resource[] @relation("SectionToChildren")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  status      ResourceStatus @default(ACTIVE)

  reservations  Reservation[]
  pricingRules PricingRule[]
  schedules    ResourceSchedule[]
  blockouts    ResourceBlockout[]
  items        ReservationItem[]
}

model Reservation {
  id              String            @id @default(uuid())
  status          ReservationStatus @default(PENDING) 

  resourceId      String?          
  resource        Resource?         @relation(fields: [resourceId], references: [id])
  
  startTime       DateTime?    
  endTime         DateTime?       

  userId          String
  user            User              @relation(fields: [userId], references: [id])

  rejectReason String?

  totalAmount     Int               @default(0)
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt

  items           ReservationItem[]
  payment         Payment?

  insuranceDocUrl String?  
  hasInsurance    Boolean           @default(false)
}

model ReservationItem {
  id String @id @default(uuid())

  reservationId String
  reservation   Reservation @relation(fields: [reservationId], references: [id])

  resourceId String
  resource   Resource @relation(fields: [resourceId], references: [id])

  appliedPricingRuleId   String?
  appliedPricingRuleType PricingRuleType?

  status ReservationItemStatus @default(PENDING)

  unitPrice Int @default(0)
  quantity  Int @default(1)
  amount    Int @default(0)

  startAt DateTime?
  endAt   DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([resourceId])
  @@index([reservationId])
}

model PricingRule {
  id String @id @default(uuid())

  resourceId String
  resource   Resource @relation(fields: [resourceId], references: [id])

  ruleType PricingRuleType @default(DEFAULT)
  userType UserType?

  dayOfWeek Int?
  startTime String?
  endTime   String?

  price    Int
  isActive Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([resourceId, isActive])
}

model ResourceSchedule {
  id String @id @default(uuid())

  resourceId String
  resource   Resource @relation(fields: [resourceId], references: [id])

  scheduleType ScheduleType @default(WEEKLY)

  dayOfWeek Int?
  openTime  String?
  closeTime String?

  date     DateTime?
  isClosed Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([resourceId, scheduleType])
}

model ResourceBlockout {
  id String @id @default(uuid())

  resourceId String
  resource   Resource @relation(fields: [resourceId], references: [id])
  type       BlockoutType @default(BLOCK)

  reason  String?
  startAt DateTime
  endAt   DateTime

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([resourceId, startAt, endAt])
}

model Holiday {
  id    String   @id @default(uuid())
  date  DateTime @unique 
  name  String   
}

model Payment {
  id String @id @default(uuid())

  reservationId String @unique
  reservation   Reservation @relation(fields: [reservationId], references: [id])

  status            PaymentStatus @default(PENDING)
  provider          String?
  providerPaymentId String?       @unique

  amount Int       @default(0)
  paidAt DateTime?

  refundedAmount Int       @default(0)
  refundedAt     DateTime?
  refundReason   String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Post {
id        String   @id @default(uuid())
  type      PostType
  status    PostStatus @default(PUBLISHED) 
  
  title     String
  content   String   @db.Text
  thumbnailUrl String? 

  viewCount Int      @default(0) 
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([type, status])
}

model Popup {
  id          String   @id @default(uuid())
  title       String  
  imageUrl    String   
  linkUrl     String?  
  
  isActive    Boolean  @default(true) 
  startDate   DateTime 
  endDate     DateTime 
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Inquiry {
  id String @id @default(uuid())

  type   InquiryType
  status InquiryStatus @default(NEW)

  userId String?
  user   User?   @relation(fields: [userId], references: [id])

  name    String?
  email   String?
  phone   String?
  message String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([status, type])
}

model NotificationLog {
  id String @id @default(uuid())

  channel NotificationChannel @default(KAKAO)
  status  NotificationStatus  @default(READY)

  userId        String?
  reservationId String?

  to      String?
  title   String?
  message String?
  error   String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}